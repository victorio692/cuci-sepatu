# Checkout Feature Documentation

## Overview
Fitur checkout yang lengkap dengan opsi pengiriman dan upload foto sepatu untuk aplikasi Cuci Sepatu.

## Features Implemented

### 1. Delivery Method Options
- **Antar (Deliver)**: Sepatu akan diantar ke alamat pelanggan
- **Jemput (Pickup)**: Sepatu akan dijemput dari alamat pelanggan
- **Langsung ke Toko (Direct to Store)**: Pelanggan datang langsung ke toko

### 2. Photo Upload
- Upload hingga 5 foto sepatu
- Maksimal ukuran per foto: 2MB
- Format yang didukung: JPG, JPEG, PNG, GIF
- Preview foto setelah dipilih
- Dapat menghapus foto sebelum submit

### 3. Smart Address Field
- Alamat field otomatis sembunyi ketika memilih "Langsung ke Toko"
- Label alamat berubah sesuai metode pengiriman:
  - Antar: "Alamat Pengantaran"
  - Jemput: "Alamat Penjemputan"

## Database Changes

### New Table: booking_photos
```sql
CREATE TABLE booking_photos (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    booking_id INT UNSIGNED NOT NULL,
    photo_path VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE,
    INDEX idx_booking_id (booking_id)
);
```

### Modified Table: bookings
```sql
ALTER TABLE bookings 
ADD COLUMN delivery_method VARCHAR(20) DEFAULT 'antar' 
AFTER opsi_kirim;
```

## Files Modified

### 1. app/Views/pages/checkout.php
**Changes:**
- Added delivery method selection (3 radio buttons with icons)
- Added photo upload section with preview
- Implemented JavaScript for:
  - Delivery method change handler (hide/show address field)
  - Photo preview with remove functionality
  - File validation (size, count)
  - Form submission with FormData (supports file upload)

### 2. app/Controllers/Booking.php
**Changes in submitCheckout():**
- Changed from JSON to FormData format
- Added photo upload handling
- Validation for max 5 photos, 2MB each
- Files saved to `writable/uploads/` with random names
- Photos linked to bookings via `booking_photos` table
- Conditional address validation (not required for 'langsung')
- Added delivery_method to booking data

### 3. Database Setup
**New Files:**
- `setup_checkout_tables.php` - Script untuk create table dan alter column
- `create_booking_photos_table.sql` - SQL untuk tabel booking_photos
- `add_delivery_method.sql` - SQL untuk tambah kolom delivery_method
- `check_bookings_structure.php` - Utility untuk check struktur tabel

## Usage Flow

1. **User adds items to cart** → Cart page
2. **User selects items** → Checkbox untuk pilih items
3. **User clicks Checkout** → Items disimpan di sessionStorage
4. **User redirected to /checkout**
5. **User selects delivery method**:
   - If "Langsung": Address field hidden
   - If "Antar/Jemput": Address field shown with appropriate label
6. **User uploads photos (optional)** → Preview displayed
7. **User fills form**:
   - Pickup/delivery date (min H+1)
   - Address (if not 'langsung')
   - Notes (optional)
8. **User clicks submit** → FormData sent to backend
9. **Backend processes**:
   - Validates and saves photos
   - Creates separate bookings for each item
   - Links photos to bookings
10. **Success** → Redirect to /my-bookings

## API Endpoint

### POST /checkout/submit

**Request Format:** FormData (multipart/form-data)

**Parameters:**
- `items` (JSON string): Array of cart items
  ```json
  [
    {
      "service_code": "basicwash",
      "service_name": "Cuci Basic",
      "quantity": 2,
      "price": 25000
    }
  ]
  ```
- `pickup_date` (date): Tanggal pickup/antar (min H+1)
- `address` (text): Alamat lengkap (not required if delivery_method = 'langsung')
- `notes` (text, optional): Catatan tambahan
- `delivery_method` (string): 'antar' | 'jemput' | 'langsung'
- `shoe_photos[]` (files, optional): Array of image files (max 5, 2MB each)

**Response:**
```json
{
  "success": true,
  "message": "3 pesanan berhasil dibuat",
  "booking_ids": [123, 124, 125]
}
```

## File Storage

Photos are saved to: `writable/uploads/`

Format: Random filename generated by CodeIgniter's `getRandomName()`

Example: `1234567890_abcdef123456.jpg`

## Validation Rules

### Client-side:
- Delivery method: Required
- Pickup date: Required, min H+1
- Address: Required (except for 'langsung')
- Photos: Max 5 files, 2MB per file
- Photo format: image/* (JPEG, PNG, GIF)

### Server-side:
- File size: Max 2MB per file
- File type: JPEG, JPG, PNG, GIF only
- Items: Must not be empty
- Address: Required if delivery_method != 'langsung'

## Cart Integration

After successful checkout:
- Selected items removed from cart (based on `selected: true`)
- Remaining unselected items stay in cart
- Cart badge updated automatically
- sessionStorage cleared

## Security Considerations

1. **File Upload Security:**
   - File type validation (MIME type check)
   - File size limit enforcement
   - Random filename generation (prevents path traversal)
   - Saved outside public directory

2. **User Authentication:**
   - User must be logged in
   - User ID from session
   - Each booking linked to user

3. **Data Validation:**
   - Server-side validation for all inputs
   - SQL injection prevention (using query builder)
   - XSS prevention (escaped output in views)

## Future Enhancements

1. Image compression before upload
2. Display uploaded photos in booking detail page
3. Allow edit/delete photos after booking
4. Multiple delivery addresses
5. Scheduled pickup time selection
6. Real-time delivery tracking
7. Photo requirements/guidelines modal

## Testing Checklist

- [ ] Select delivery method: Antar
- [ ] Select delivery method: Jemput  
- [ ] Select delivery method: Langsung (address should hide)
- [ ] Upload 1 photo
- [ ] Upload 5 photos (max)
- [ ] Try upload 6 photos (should show alert)
- [ ] Try upload > 2MB file (should skip)
- [ ] Remove photo from preview
- [ ] Submit without delivery method (should show alert)
- [ ] Submit without date (should show validation)
- [ ] Submit without address for antar/jemput (should show validation)
- [ ] Submit with all valid data (should create bookings)
- [ ] Check cart after checkout (selected items removed)
- [ ] Check my-bookings page (new orders appear)
- [ ] Check database: bookings table (delivery_method saved)
- [ ] Check database: booking_photos table (photos linked)
- [ ] Check writable/uploads folder (files saved)

## Troubleshooting

### Photos not uploading
1. Check `writable/uploads/` folder exists and is writable
2. Check PHP upload_max_filesize and post_max_size settings
3. Check browser console for JavaScript errors

### Address field not hiding for 'langsung'
1. Check delivery method radio button values
2. Check JavaScript console for errors
3. Verify addressField element exists

### Cart items not removing after checkout
1. Check sessionStorage has checkoutItems
2. Check cart key matches (cart_user_{id})
3. Check localStorage data before/after

### Database errors
1. Run `setup_checkout_tables.php` to create tables
2. Check database name in config matches
3. Verify foreign key constraints

## Notes

- Photos are optional, user can checkout without uploading
- Each cart item becomes a separate booking in database
- All bookings from same checkout share same photos
- Photos saved to `writable/uploads/` NOT `public/uploads/`
- Use `WRITEPATH . 'uploads'` in controller
